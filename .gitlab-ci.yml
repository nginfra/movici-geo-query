image: eu.gcr.io/movici-develop/cicd-build-env:latest

stages:
  - test
  - build
  - upload

variables:
  KUBERNETES_MEMORY_REQUEST: 1536Mi
  KUBERNETES_MEMORY_LIMIT: 1536Mi
  KUBERNETES_CPU_REQUEST: 600m
  KUBERNETES_CPU_LIMIT: 1000m

test:
  stage: test
  script:
    - pip install -r requirements.txt
    - pip install -r requirements-dev.txt
    - python setup.py build_ext
    - pip wheel --no-deps .
    - pip install *.whl
    - make test-all

build:
  stage: build
  artifacts:
    untracked: true
  script:
    - pip install -r requirements.txt
    - pip wheel --no-deps .

upload:
  stage: upload
  dependencies:
    - build
  only:
    - master
    - /^.*testci-.*$/
  script:
    - twine upload --repository-url $PYPI_SERVER *.whl